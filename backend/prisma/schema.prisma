generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADM
  COMUNICACAO
  TESOUREIRO
  ARRECADACAO
  USUARIO_PADRAO
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELED
  FAILED
}

enum PaymentMethod {
  PIX
  CARD
}

model Diocese {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  users     User[]
  donations Donation[]
}

model User {
  id            String   @id @default(cuid())
  name          String
  whatsapp      String   @unique
  birthDate     DateTime
  dioceseId     String
  city          String
  prayerGroup   String
  passwordHash  String
  role          Role     @default(USUARIO_PADRAO)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  diocese       Diocese  @relation(fields: [dioceseId], references: [id])
  refreshTokens RefreshToken[]
  donations     Donation[]
  orders        Order[]
  ticketSales   CampaignTicket[] @relation("SellerSales")
}

model RefreshToken {
  id         String   @id @default(cuid())
  tokenHash  String
  userId     String
  createdAt  DateTime @default(now())
  revokedAt  DateTime?

  user       User     @relation(fields: [userId], references: [id])
}

model Donation {
  id          String        @id @default(cuid())
  userId      String
  dioceseId   String
  amountCents Int
  createdAt   DateTime      @default(now())

  paymentId   String?       @unique
  payment     Payment?      @relation(fields: [paymentId], references: [id])

  user        User          @relation(fields: [userId], references: [id])
  diocese     Diocese       @relation(fields: [dioceseId], references: [id])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  priceCents  Int
  stockQty    Int
  images      String[] // URLs
  sizes       String[] // ex: ["P","M","G","GG"] when applicable
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orderItems  OrderItem[]
}

model Order {
  id          String        @id @default(cuid())
  userId      String
  status      PaymentStatus @default(PENDING)
  totalCents  Int
  createdAt   DateTime      @default(now())

  paymentId   String?       @unique
  payment     Payment?      @relation(fields: [paymentId], references: [id])

  user        User          @relation(fields: [userId], references: [id])
  items       OrderItem[]
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  productId  String
  qty        Int
  priceCents Int

  order      Order   @relation(fields: [orderId], references: [id])
  product    Product @relation(fields: [productId], references: [id])
}

model Campaign {
  id             String   @id @default(cuid())
  title          String
  description    String
  prizeImages    String[]
  totalTickets   Int
  numberingMode  String   // "sequential" | "custom"
  drawDate       DateTime
  drawLocation   String
  reserveMinutes Int      // 10 or 30
  createdAt      DateTime @default(now())

  sellers        CampaignSeller[]
  tickets        CampaignTicket[]
}

model CampaignSeller {
  id          String   @id @default(cuid())
  campaignId  String
  sellerId    String

  campaign    Campaign @relation(fields: [campaignId], references: [id])
  seller      User     @relation(fields: [sellerId], references: [id])

  @@unique([campaignId, sellerId])
}

model CampaignTicket {
  id           String        @id @default(cuid())
  campaignId   String
  number       Int
  buyerName    String
  buyerWhatsapp String
  sellerId     String
  status       PaymentStatus @default(PENDING)
  reservedUntil DateTime
  createdAt    DateTime      @default(now())

  paymentId    String?       @unique
  payment      Payment?      @relation(fields: [paymentId], references: [id])

  campaign     Campaign      @relation(fields: [campaignId], references: [id])
  seller       User          @relation("SellerSales", fields: [sellerId], references: [id])

  @@unique([campaignId, number])
}

model Payment {
  id            String        @id @default(cuid())
  referenceType String        // donation|order|ticket
  referenceId   String
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  amountCents   Int
  provider      String        @default("PAGBANK")
  providerId    String?       // id/charge id from PagBank
  pixQrCode     String?
  pixCopyPaste  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}
