version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: rcc
      POSTGRES_PASSWORD: rcc
      POSTGRES_DB: rcc
    ports:
      - "5432:5432"
    volumes:
      - rcc_db:/var/lib/postgresql/data

  backend:
    image: node:20-alpine
    working_dir: /app
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql://rcc:rcc@db:5432/rcc?schema=public
      JWT_SECRET: changeme_dev
      JWT_REFRESH_SECRET: changeme_refresh_dev
      PORT: "3001"
      CORS_ORIGIN: http://localhost:3000
      PAGBANK_ENV: sandbox
      PAGBANK_TOKEN: ""
      PAGBANK_WEBHOOK_SECRET: ""
    ports:
      - "3001:3001"
    volumes:
      - ./backend:/app
      - ./backend/uploads:/app/uploads
    command: >
      sh -lc "
      npm i &&
      npx prisma generate &&
      npx prisma migrate dev --name init &&
      npm run seed &&
      npm run dev
      "

  frontend:
    image: node:20-alpine
    working_dir: /app
    depends_on:
      - backend
    environment:
      NEXT_PUBLIC_API_BASE: http://localhost:3001
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
    command: >
      sh -lc "
      npm i &&
      npm run dev -- --port 3000 --hostname 0.0.0.0
      "

volumes:
  rcc_db:
